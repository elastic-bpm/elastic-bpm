<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Elastic BPM Dashboard">
    <meta name="author" content="Johannes Bertens">

    <title>Elastic BPM - Dashboard</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/metisMenu.min.css" rel="stylesheet">
    <link href="css/timeline.css" rel="stylesheet">
    <link href="css/startmin.css" rel="stylesheet">
    <link href="css/morris.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>

<div id="wrapper">

    <!-- Navigation -->
    <nav id="navbar" class="navbar navbar-inverse navbar-fixed-top" role="navigation"></nav>

    <!-- Page Content -->
    <div id="page-wrapper">
        <div id="dashboard" class="container-fluid"></div>
		<div id="timeline" class="container-fluid" style="display:none"></div>
		<div id="console" class="container-fluid" style="display:none"></div>
        <div id="machines" class="container-fluid" style="display:none"></div>
        <div id="workflows" class="container-fluid" style="display:none"></div>
	</div>

</div>

<script src="js/jquery.min.js"></script>
<script src="js/jquery.loadTemplate.js"></script>
<script src="js/clipboard.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/metisMenu.min.js"></script>
<script src="js/startmin.js"></script>

<script id="extend_timeline">
	var lastTimeLineInverted = false;
    jQuery.fn.extend({
        register_events: function(socket) {
            socket.on('event', (event) => {
                if (event.title === "publish") { 
                    if (!lastTimeLineInverted) {
                        event.inverted = "timeline-inverted";
                    }
                    lastTimeLineInverted = !lastTimeLineInverted;

                    this.loadTemplate("templates/timeline-template.html", event, { prepend: true});
                }
            });
        }
    });
</script>

<script id="load_status">
    jQuery.fn.extend({
        load_status: function(location) {
            $.get(location, (status_data) => {
                status_data = status_data.map((obj) => {
                    if (obj.status == 200) {
                        obj.class = "glyphicon-ok-sign good";
                    } else {
                        obj.class = "glyphicon-remove-sign bad";
                    }
                    return obj;
                });
                this.loadTemplate("templates/widget-template.html", status_data);
            });

            setTimeout(() => this.load_status(location), 2000); // POLLING
        }
    });
</script>

<script id="load_workflows">
    $.addTemplateFormatter({
        WorkflowDeleteButton: function(value, template) {
            return "delete-workflow-" + value + "-button";
        }
    });

    create_workflow = function() {
        var name = $("#workflow-name").val();
        var owner = $("#workflow-owner").val();
        var description = $("#workflow-description").val();

        // Elaborate post, because I want to use the body
        $.ajax({
            contentType: 'application/json',
            data: JSON.stringify({"name": name, "owner": owner, "description": description}),
            success: function(data){
                console.log(data);
                $('#workflow-create-form').trigger('reset');
            },
            error: function(error){
                console.log(error);
            },
            type: 'POST',
            url: '/workflows'
        });
    };

    delete_workflow = function(workflow_id) {
        $.ajax({
            success: function(data){
                console.log(data);
            },
            error: function(error){
                console.log(error);
            },
            type: 'DELETE',
            url: '/workflows/' + workflow_id
        });
    };

    workflow_template_shown = false;
    show_workflows = function() {
        $.get('/workflows', (workflows) => {
            if (!workflow_template_shown) {
                $.get("/parts/workflows.html", (data) => {
                    $("#workflows").html(data);
                    $("#workflow-create-button").on('click', create_workflow);
                    workflow_template_shown = true;       
                });
            } else {
                $("#workflows-table-body").loadTemplate("templates/workflows-template.html", workflows);
                workflows.forEach((item) => {
                    $("#delete-workflow-" + item.id + "-button").on('click', (event) => delete_workflow(item.id));
                });
            }
        }).fail(() => {
            $.get("/parts/workflows_error.html", (data) => {
                    $("#workflows").html(data);
            });
            workflow_template_shown = false;
        });

        setTimeout(show_workflows, 2000); // POLLING
    };
</script>

<script id="load_machines">
    shown_machine_page = "";
    show_machines_table = function () {
        $.get("/status", (status) => {
            status.forEach((item) => {
                if (item.name === 'elastic-scaling' && item.status === 206) {
                    if (shown_machine_page != "login") {
                        // Show login
                        $.get("/parts/machines_login.html", (data) => {
                            $("#machines").html(data);
                            new Clipboard('#azure_login_button');
                            $("#azure_login_code").html(item.message);
                        });
                        shown_machine_page = "login";
                    };
                    $("#azure_login_code").html(item.message);
                } else if (item.name === 'elastic-scaling' && item.status === 200) {
                    if (shown_machine_page != "table") {
                        // Show machines
                        $.get("/parts/machines.html", (data) => {
                            $("#machines").html(data);
                        });
                        shown_machine_page = "table";
                    };
                    fill_machines_table();
                } else if (item.name === 'elastic-scaling'){
                    if (shown_machine_page != "error") {
                        // Can not connect
                        $.get("/parts/machines_error.html", (data) => {
                            $("#machines").html(data);
                        });
                        shown_machine_page = "error";
                    };
                }
            });
        });

        setTimeout(show_machines_table, 2000);
    };

    fill_machines_table = function () {
        $.get('/virtualmachines', (status_data) => {
            $("#machines-table-body").loadTemplate("templates/machines-template.html", status_data, {success: () => {
                status_data.forEach((obj) => {
                    $("#start-button-" + obj.name).on('click', () => start_machine(obj.vmId));
                    $("#pause-button-" + obj.name).on('click', () => pause_machine(obj.vmId));
                });
            }});
        }).fail(() => {
            console.log("unable to get VM data");
        });
    };

    $.addTemplateFormatter({
        ButtonId: function(value, template) {
            return template + "-button-" + value;
        },
        StartIsDisabled: function(value, template) {
            if (value === "VM running") {
                return template + " disabled";
            } else {
                return template;
            }
        },
        PauseIsDisabled: function(value, template) {
            if (value === "VM running") {
                return template;
            } else {
                return template + " disabled";
            }
        },
        StopIsDisabled: function(value, template) {
            return template + " disabled";
        }
    });

    start_machine = function(machine_id) {
        $.post( "/virtualmachines/"+machine_id+"/start" ).done(function( data ) {
            console.log(data);
        });
    };

    pause_machine = function(machine_id) {
        $.post( "/virtualmachines/"+machine_id+"/stop" ).done(function( data ) {
            console.log(data);
        });
    };
</script>

<script id="selector_click">
    jQuery.fn.extend({
        show_item: function(content) {
            this.on('click', () => {
                hideAll();
				content.show();
            });
        }
    });
</script>

<script src="/socket.io/socket.io.js"></script>
<script id="main">
    var hideAll = function() {
        $("#timeline").hide();
        $("#dashboard").hide();
        $("#console").hide();
        $("#machines").hide();
        $("#workflows").hide();
    };
  	var socket = io();

	$( document ).ready(function() {
		$.get("/parts/navbar.html", (data) => {
			$("#navbar").html(data);

			// Register clicks after loading the items :-)
			$("#show-timeline").show_item($("#timeline"));
			$("#show-dashboard").show_item($("#dashboard"));
			$("#show-console").show_item($("#console"));
            $("#show-machines").show_item($("#machines"));
            $("#show-workflows").show_item($("#workflows"));
		});

		$.get("/parts/timeline.html", (data) => {
			$("#timeline").html(data);
			$("#timeline-list").register_events(socket);
		});

		$.get("/parts/console.html", (data) => {
            $("#console").html(data);
            socket.on('event', (event) => { 
                $("#console-output").prepend(event.time + ":" + event.message + "\n");
            });
        });

        $.get("/parts/dashboard.html", (data) => {
            $("#dashboard").html(data);
            $("#dashboard-status").load_status('/status');
        });

        show_workflows();
        show_machines_table();
	});
</script>

</body>
</html>