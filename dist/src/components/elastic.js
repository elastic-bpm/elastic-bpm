"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const elasticsearch = require("elasticsearch");
const rx_elasticsearch_1 = require("rx-elasticsearch");
class Elastic {
    constructor() {
        this.elastic_host = process.env.ELASTIC_HOST || '137.116.195.67';
        this.client = new elasticsearch.Client({
            host: this.elastic_host + ':9200',
            log: 'info'
        });
        this.startTime = new Date().getTime(); // NOW
        this.component = {};
        this.messages = [];
        this.rawLoad = [];
        this.maxLoadLength = 10;
        this.status = {
            message: 'not updated yet',
            statusCode: 500
        };
        this.machineLoad = {};
    }
    start_updates(interval) {
        this.update_status(interval);
        this.update_messages(interval);
        this.update_load(interval);
    }
    update_load(interval) {
        let from = this.startTime;
        if (this.rawLoad.length > 0) {
            from = new Date(this.rawLoad[0]['@timestamp']).getTime();
        }
        const query = {
            index: 'metricbeat-*',
            scroll: '30s',
            body: {
                query: {
                    bool: {
                        must: [
                            {
                                query_string: {
                                    analyze_wildcard: true,
                                    query: '*'
                                }
                            },
                            {
                                match: {
                                    'metricset.name': {
                                        query: 'load',
                                        type: 'phrase'
                                    }
                                }
                            },
                            {
                                range: {
                                    '@timestamp': {
                                        gt: from,
                                        format: 'epoch_millis'
                                    }
                                }
                            }
                        ],
                        must_not: new Array()
                    }
                }
            }
        };
        const rxClient = new rx_elasticsearch_1.default(this.client);
        rxClient
            .scroll(query)
            .subscribe((response) => {
            const newLoad = [];
            response.hits.hits.forEach((hit) => {
                newLoad.push(hit._source);
                newLoad.sort(function (a, b) {
                    if (a['@timestamp'] < b['@timestamp']) {
                        return -1;
                    }
                    else {
                        return 1;
                    }
                });
                newLoad.forEach((load) => {
                    if (Object.keys(this.machineLoad).indexOf(load.beat.hostname) !== -1) {
                        this.machineLoad[load.beat.hostname].load1.push(load.system.load['1']);
                        if (this.machineLoad[load.beat.hostname].load1.length > this.maxLoadLength) {
                            this.machineLoad[load.beat.hostname].load1 = this.machineLoad[load.beat.hostname].load1.slice(1);
                        }
                        this.machineLoad[load.beat.hostname].load5.push(load.system.load['5']);
                        if (this.machineLoad[load.beat.hostname].load5.length > this.maxLoadLength) {
                            this.machineLoad[load.beat.hostname].load5 = this.machineLoad[load.beat.hostname].load5.slice(1);
                        }
                        this.machineLoad[load.beat.hostname].load15.push(load.system.load['15']);
                        if (this.machineLoad[load.beat.hostname].load15.length > this.maxLoadLength) {
                            this.machineLoad[load.beat.hostname].load15 = this.machineLoad[load.beat.hostname].load15.slice(1);
                        }
                    }
                    else {
                        this.machineLoad[load.beat.hostname] = {
                            load1: [load.system.load['1']],
                            load5: [load.system.load['5']],
                            load15: [load.system.load['15']],
                        };
                    }
                });
                console.log(newLoad.length);
                if (newLoad.length > 0) {
                    this.rawLoad = newLoad;
                }
                setTimeout(() => { this.update_load(interval); }, interval);
            });
        }, (e) => console.error(e));
    }
    update_messages(interval) {
        let from = this.startTime;
        if (this.messages.length > 0) {
            from = new Date(this.messages[0]['@timestamp']).getTime();
        }
        const messagesQuery = {
            index: 'logstash-*',
            scroll: '30s',
            body: {
                query: {
                    bool: {
                        must: [{
                                query_string: {
                                    query: '*',
                                    analyze_wildcard: true
                                }
                            }, {
                                range: {
                                    '@timestamp': {
                                        gt: from,
                                        format: 'epoch_millis'
                                    }
                                }
                            }]
                    }
                }
            }
        };
        const rxClient = new rx_elasticsearch_1.default(this.client);
        rxClient
            .scroll(messagesQuery)
            .subscribe((response) => {
            const newMessages = [];
            response.hits.hits.forEach((hit) => {
                newMessages.push(hit._source);
            });
            newMessages.sort((a, b) => {
                if (a['@timestamp'] < b['@timestamp']) {
                    return 1;
                }
                else {
                    return -1;
                }
            });
            this.messages = newMessages.concat(this.messages);
            this.messages = this.messages.slice(0, 100);
            setTimeout(() => { this.update_messages(interval); }, interval);
        }, (e) => console.error(e));
    }
    update_status(interval) {
        this.client.ping({
            // ping usually has a 3000ms timeout
            requestTimeout: 1000
        }, (error) => {
            if (error) {
                this.status = {
                    message: 'ELK Down',
                    statusCode: 400
                };
                setTimeout(() => this.update_status(interval), interval);
            }
            else {
                this.status = {
                    message: 'OK',
                    statusCode: 200
                };
                setTimeout(() => this.update_status(interval), interval);
            }
        });
    }
    check_status() {
        return this.status;
    }
    get_messages() {
        return this.messages;
    }
    get_load() {
        return this.machineLoad;
    }
}
exports.Elastic = Elastic;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21wb25lbnRzL2VsYXN0aWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQ0FBK0M7QUFDL0MsdURBQXdDO0FBR3hDO0lBQUE7UUFDSSxpQkFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLGdCQUFnQixDQUFDO1FBQzVELFdBQU0sR0FBRyxJQUFJLGFBQWEsQ0FBQyxNQUFNLENBQUM7WUFDOUIsSUFBSSxFQUFFLElBQUksQ0FBQyxZQUFZLEdBQUcsT0FBTztZQUNqQyxHQUFHLEVBQUUsTUFBTTtTQUNkLENBQUMsQ0FBQztRQUVILGNBQVMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsTUFBTTtRQUV4QyxjQUFTLEdBQVEsRUFBRSxDQUFDO1FBQ3BCLGFBQVEsR0FBVSxFQUFFLENBQUM7UUFDckIsWUFBTyxHQUFVLEVBQUUsQ0FBQztRQUNwQixrQkFBYSxHQUFHLEVBQUUsQ0FBQztRQUVuQixXQUFNLEdBQVE7WUFDVixPQUFPLEVBQUUsaUJBQWlCO1lBQzFCLFVBQVUsRUFBRSxHQUFHO1NBQ2xCLENBQUM7UUFDRixnQkFBVyxHQUFRLEVBQUUsQ0FBQztJQWdNMUIsQ0FBQztJQTlMRyxhQUFhLENBQUMsUUFBZ0I7UUFDMUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQy9CLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVELFdBQVcsQ0FBQyxRQUFnQjtRQUN4QixJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQzFCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDMUIsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM3RCxDQUFDO1FBRUQsTUFBTSxLQUFLLEdBQUc7WUFDVixLQUFLLEVBQUUsY0FBYztZQUNyQixNQUFNLEVBQUUsS0FBSztZQUNiLElBQUksRUFBRTtnQkFDRixLQUFLLEVBQUU7b0JBQ0gsSUFBSSxFQUFFO3dCQUNGLElBQUksRUFBRTs0QkFDRjtnQ0FDSSxZQUFZLEVBQUU7b0NBQ1YsZ0JBQWdCLEVBQUUsSUFBSTtvQ0FDdEIsS0FBSyxFQUFFLEdBQUc7aUNBQ2I7NkJBQ0o7NEJBQ0Q7Z0NBQ0ksS0FBSyxFQUFFO29DQUNILGdCQUFnQixFQUFFO3dDQUNkLEtBQUssRUFBRSxNQUFNO3dDQUNiLElBQUksRUFBRSxRQUFRO3FDQUNqQjtpQ0FDSjs2QkFDSjs0QkFDRDtnQ0FDSSxLQUFLLEVBQUU7b0NBQ0gsWUFBWSxFQUFFO3dDQUNWLEVBQUUsRUFBRSxJQUFJO3dDQUNSLE1BQU0sRUFBRSxjQUFjO3FDQUN6QjtpQ0FDSjs2QkFDSjt5QkFDSjt3QkFDRCxRQUFRLEVBQUUsSUFBSSxLQUFLLEVBQUU7cUJBQ3hCO2lCQUNKO2FBQ0o7U0FDSixDQUFDO1FBRUYsTUFBTSxRQUFRLEdBQUcsSUFBSSwwQkFBUSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMzQyxRQUFRO2FBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQzthQUNiLFNBQVMsQ0FDVixDQUFDLFFBQWE7WUFDVixNQUFNLE9BQU8sR0FBVSxFQUFFLENBQUM7WUFFMUIsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBUTtnQkFDaEMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQzFCLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFNLEVBQUUsQ0FBTTtvQkFDakMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ3BDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDZCxDQUFDO29CQUFDLElBQUksQ0FBQyxDQUFDO3dCQUNKLE1BQU0sQ0FBQyxDQUFDLENBQUM7b0JBQ2IsQ0FBQztnQkFDTCxDQUFDLENBQUMsQ0FBQztnQkFDSCxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBUztvQkFDdEIsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUNuRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO3dCQUN2RSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQzs0QkFDekUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDckcsQ0FBQzt3QkFFRCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO3dCQUN2RSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQzs0QkFDekUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDckcsQ0FBQzt3QkFFRCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO3dCQUN6RSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQzs0QkFDMUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDdkcsQ0FBQztvQkFDTCxDQUFDO29CQUFDLElBQUksQ0FBQyxDQUFDO3dCQUNKLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRzs0QkFDbkMsS0FBSyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7NEJBQzlCLEtBQUssRUFBRSxDQUFDLElB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cG9ydCAqIGFzIGVsYXN0aWNzZWFyY2ggZnJvbSAnZWxhc3RpY3NlYXJjaCc7XHJcbmltcG9ydCBSeENsaWVudCBmcm9tICdyeC1lbGFzdGljc2VhcmNoJztcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgRWxhc3RpYyB7XHJcbiAgICBlbGFzdGljX2hvc3QgPSBwcm9jZXNzLmVudi5FTEFTVElDX0hPU1QgfHwgJzEzNy4xMTYuMTk1LjY3JztcclxuICAgIGNsaWVudCA9IG5ldyBlbGFzdGljc2VhcmNoLkNsaWVudCh7XHJcbiAgICAgICAgaG9zdDogdGhpcy5lbGFzdGljX2hvc3QgKyAnOjkyMDAnLFxyXG4gICAgICAgIGxvZzogJ2luZm8nXHJcbiAgICB9KTtcclxuXHJcbiAgICBzdGFydFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsgLy8gTk9XXHJcblxyXG4gICAgY29tcG9uZW50OiBhbnkgPSB7fTtcclxuICAgIG1lc3NhZ2VzOiBhbnlbXSA9IFtdO1xyXG4gICAgcmF3TG9hZDogYW55W10gPSBbXTtcclxuICAgIG1heExvYWRMZW5ndGggPSAxMDtcclxuXHJcbiAgICBzdGF0dXM6IGFueSA9IHtcclxuICAgICAgICBtZXNzYWdlOiAnbm90IHVwZGF0ZWQgeWV0JyxcclxuICAgICAgICBzdGF0dXNDb2RlOiA1MDBcclxuICAgIH07XHJcbiAgICBtYWNoaW5lTG9hZDogYW55ID0ge307XHJcblxyXG4gICAgc3RhcnRfdXBkYXRlcyhpbnRlcnZhbDogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGVfc3RhdHVzKGludGVydmFsKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZV9tZXNzYWdlcyhpbnRlcnZhbCk7XHJcbiAgICAgICAgdGhpcy51cGRhdGVfbG9hZChpbnRlcnZhbCk7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlX2xvYWQoaW50ZXJ2YWw6IG51bWJlcikge1xyXG4gICAgICAgIGxldCBmcm9tID0gdGhpcy5zdGFydFRpbWU7XHJcbiAgICAgICAgaWYgKHRoaXMucmF3TG9hZC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGZyb20gPSBuZXcgRGF0ZSh0aGlzLnJhd0xvYWRbMF1bJ0B0aW1lc3RhbXAnXSkuZ2V0VGltZSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcXVlcnkgPSB7XHJcbiAgICAgICAgICAgIGluZGV4OiAnbWV0cmljYmVhdC0qJyxcclxuICAgICAgICAgICAgc2Nyb2xsOiAnMzBzJyxcclxuICAgICAgICAgICAgYm9keToge1xyXG4gICAgICAgICAgICAgICAgcXVlcnk6IHtcclxuICAgICAgICAgICAgICAgICAgICBib29sOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG11c3Q6IFtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVyeV9zdHJpbmc6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5hbHl6ZV93aWxkY2FyZDogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnk6ICcqJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2g6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ21ldHJpY3NldC5uYW1lJzoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnk6ICdsb2FkJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdwaHJhc2UnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdAdGltZXN0YW1wJzoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3Q6IGZyb20sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXQ6ICdlcG9jaF9taWxsaXMnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG11c3Rfbm90OiBuZXcgQXJyYXkoKVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGNvbnN0IHJ4Q2xpZW50ID0gbmV3IFJ4Q2xpZW50KHRoaXMuY2xpZW50KTtcclxuICAgICAgICByeENsaWVudFxyXG4gICAgICAgICAgICAuc2Nyb2xsKHF1ZXJ5KVxyXG4gICAgICAgICAgICAuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAocmVzcG9uc2U6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbmV3TG9hZDogYW55W10gPSBbXTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXNwb25zZS5oaXRzLmhpdHMuZm9yRWFjaCgoaGl0OiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBuZXdMb2FkLnB1c2goaGl0Ll9zb3VyY2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld0xvYWQuc29ydChmdW5jdGlvbiAoYTogYW55LCBiOiBhbnkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFbJ0B0aW1lc3RhbXAnXSA8IGJbJ0B0aW1lc3RhbXAnXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIC0xO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBuZXdMb2FkLmZvckVhY2goKGxvYWQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmtleXModGhpcy5tYWNoaW5lTG9hZCkuaW5kZXhPZihsb2FkLmJlYXQuaG9zdG5hbWUpICE9PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tYWNoaW5lTG9hZFtsb2FkLmJlYXQuaG9zdG5hbWVdLmxvYWQxLnB1c2gobG9hZC5zeXN0ZW0ubG9hZFsnMSddKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm1hY2hpbmVMb2FkW2xvYWQuYmVhdC5ob3N0bmFtZV0ubG9hZDEubGVuZ3RoID4gdGhpcy5tYXhMb2FkTGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tYWNoaW5lTG9hZFtsb2FkLmJlYXQuaG9zdG5hbWVdLmxvYWQxID0gdGhpcy5tYWNoaW5lTG9hZFtsb2FkLmJlYXQuaG9zdG5hbWVdLmxvYWQxLnNsaWNlKDEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWFjaGluZUxvYWRbbG9hZC5iZWF0Lmhvc3RuYW1lXS5sb2FkNS5wdXNoKGxvYWQuc3lzdGVtLmxvYWRbJzUnXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tYWNoaW5lTG9hZFtsb2FkLmJlYXQuaG9zdG5hbWVdLmxvYWQ1Lmxlbmd0aCA+IHRoaXMubWF4TG9hZExlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWFjaGluZUxvYWRbbG9hZC5iZWF0Lmhvc3RuYW1lXS5sb2FkNSA9IHRoaXMubWFjaGluZUxvYWRbbG9hZC5iZWF0Lmhvc3RuYW1lXS5sb2FkNS5zbGljZSgxKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1hY2hpbmVMb2FkW2xvYWQuYmVhdC5ob3N0bmFtZV0ubG9hZDE1LnB1c2gobG9hZC5zeXN0ZW0ubG9hZFsnMTUnXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tYWNoaW5lTG9hZFtsb2FkLmJlYXQuaG9zdG5hbWVdLmxvYWQxNS5sZW5ndGggPiB0aGlzLm1heExvYWRMZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1hY2hpbmVMb2FkW2xvYWQuYmVhdC5ob3N0bmFtZV0ubG9hZDE1ID0gdGhpcy5tYWNoaW5lTG9hZFtsb2FkLmJlYXQuaG9zdG5hbWVdLmxvYWQxNS5zbGljZSgxKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWFjaGluZUxvYWRbbG9hZC5iZWF0Lmhvc3RuYW1lXSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkMTogW2xvYWQuc3lzdGVtLmxvYWRbJzEnXV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZDU6IFtsb2FkLnN5c3RlbS5sb2FkWyc1J11dLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWQxNTogW2xvYWQuc3lzdGVtLmxvYWRbJzE1J11dLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhuZXdMb2FkLmxlbmd0aCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5ld0xvYWQubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJhd0xvYWQgPSBuZXdMb2FkO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IHRoaXMudXBkYXRlX2xvYWQoaW50ZXJ2YWwpOyB9LCBpbnRlcnZhbCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgKGU6IGFueSkgPT4gY29uc29sZS5lcnJvcihlKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZV9tZXNzYWdlcyhpbnRlcnZhbDogbnVtYmVyKSB7XHJcbiAgICAgICAgbGV0IGZyb20gPSB0aGlzLnN0YXJ0VGltZTtcclxuICAgICAgICBpZiAodGhpcy5tZXNzYWdlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGZyb20gPSBuZXcgRGF0ZSh0aGlzLm1lc3NhZ2VzWzBdWydAdGltZXN0YW1wJ10pLmdldFRpbWUoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IG1lc3NhZ2VzUXVlcnkgPSB7XHJcbiAgICAgICAgICAgIGluZGV4OiAnbG9nc3Rhc2gtKicsXHJcbiAgICAgICAgICAgIHNjcm9sbDogJzMwcycsXHJcbiAgICAgICAgICAgIGJvZHk6IHtcclxuICAgICAgICAgICAgICAgIHF1ZXJ5OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgYm9vbDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtdXN0OiBbe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnlfc3RyaW5nOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnk6ICcqJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmFseXplX3dpbGRjYXJkOiB0cnVlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0B0aW1lc3RhbXAnOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGd0OiBmcm9tLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXQ6ICdlcG9jaF9taWxsaXMnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGNvbnN0IHJ4Q2xpZW50ID0gbmV3IFJ4Q2xpZW50KHRoaXMuY2xpZW50KTtcclxuICAgICAgICByeENsaWVudFxyXG4gICAgICAgICAgICAuc2Nyb2xsKG1lc3NhZ2VzUXVlcnkpXHJcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgIChyZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdNZXNzYWdlczogYW55W10gPSBbXTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXNwb25zZS5oaXRzLmhpdHMuZm9yRWFjaCgoaGl0OiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBuZXdNZXNzYWdlcy5wdXNoKGhpdC5fc291cmNlKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgbmV3TWVzc2FnZXMuc29ydCgoYTogYW55LCBiOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYVsnQHRpbWVzdGFtcCddIDwgYlsnQHRpbWVzdGFtcCddKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAxO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAtMTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2VzID0gbmV3TWVzc2FnZXMuY29uY2F0KHRoaXMubWVzc2FnZXMpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tZXNzYWdlcyA9IHRoaXMubWVzc2FnZXMuc2xpY2UoMCwgMTAwKTtcclxuXHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy51cGRhdGVfbWVzc2FnZXMoaW50ZXJ2YWwpOyB9LCBpbnRlcnZhbCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIChlOiBhbnkpID0+IGNvbnNvbGUuZXJyb3IoZSlcclxuICAgICAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVfc3RhdHVzKGludGVydmFsOiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLmNsaWVudC5waW5nKHtcclxuICAgICAgICAgICAgLy8gcGluZyB1c3VhbGx5IGhhcyBhIDMwMDBtcyB0aW1lb3V0XHJcbiAgICAgICAgICAgIHJlcXVlc3RUaW1lb3V0OiAxMDAwXHJcbiAgICAgICAgfSwgKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cyA9IHtcclxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnRUxLIERvd24nLFxyXG4gICAgICAgICAgICAgICAgICAgIHN0YXR1c0NvZGU6IDQwMFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy51cGRhdGVfc3RhdHVzKGludGVydmFsKSwgaW50ZXJ2YWwpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogJ09LJyxcclxuICAgICAgICAgICAgICAgICAgICBzdGF0dXNDb2RlOiAyMDBcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMudXBkYXRlX3N0YXR1cyhpbnRlcnZhbCksIGludGVydmFsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNoZWNrX3N0YXR1cygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zdGF0dXM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0X21lc3NhZ2VzKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1lc3NhZ2VzO1xyXG4gICAgfVxyXG5cclxuICAgIGdldF9sb2FkKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1hY2hpbmVMb2FkO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==
