/*jshint esversion: 6 */
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class Scheduler {
    constructor() {
        this.Client = require('node-rest-client').Client;
        this.client = new this.Client();
        this.scheduler_host = process.env.SCHEDULER_HOST || 'localhost';
        this.status = {
            message: 'not updated yet',
            statusCode: 500
        };
        this.info = {};
        this.humanTasks = [];
    }
    start_updates(interval) {
        this.update_status(interval);
        this.update_info(interval);
        this.update_human_tasks(interval);
    }
    update_human_tasks(interval) {
        const req = this.client.get('http://' + this.scheduler_host + ':3210/tasks/human', (data, response) => {
            if (response.statusCode === 200) {
                this.humanTasks = data;
            }
            if (interval > 0) {
                setTimeout(() => this.update_human_tasks(interval), interval);
            }
        });
        req.on('error', (error) => {
            if (interval > 0) {
                setTimeout(() => this.update_human_tasks(interval), interval);
            }
        });
    }
    update_status(interval) {
        const req = this.client.get('http://' + this.scheduler_host + ':3210/status', (data, response) => {
            this.status.statusCode = response.statusCode;
            this.status.message = response.statusMessage;
            setTimeout(() => this.update_status(interval), interval);
        });
        req.on('error', (error) => {
            this.status.statusCode = 500;
            this.status.message = error.code;
            setTimeout(() => this.update_status(interval), interval);
        });
    }
    update_info(interval) {
        const req = this.client.get('http://' + this.scheduler_host + ':3210/info', (data, response) => {
            if (response.statusCode === 200) {
                this.info = data;
                setTimeout(() => this.update_info(interval), interval);
            }
            else {
                setTimeout(() => this.update_info(interval), interval);
            }
        });
        req.on('error', (error) => {
            setTimeout(() => this.update_info(interval), interval);
        });
    }
    set_policy(body, cb) {
        console.log(body);
        const req = this.client.post('http://' + this.scheduler_host + ':3210/policy/' + body.policy, (data, response) => {
            if (response.statusCode === 200) {
                cb(null, data);
            }
            else {
                cb('Error: ' + data, null);
            }
        });
        req.on('error', (error) => {
            cb('error: ' + error, null);
        });
    }
    set_amount(body, cb) {
        console.log(body);
        const req = this.client.post('http://' + this.scheduler_host + ':3210/amount/' + body.policy + '/' + body.amount, (data, response) => {
            if (response.statusCode === 200) {
                cb(null, data);
            }
            else {
                cb('Error: ' + data, null);
            }
        });
        req.on('error', (error) => {
            cb('error: ' + error, null);
        });
    }
    execute(body, cb) {
        console.log(body);
        const args = {
            data: body,
            headers: { 'Content-Type': 'application/json' }
        };
        const req = this.client.post('http://' + this.scheduler_host + ':3210/execute/', args, (data, response) => {
            if (response.statusCode === 200) {
                cb(null, data);
            }
            else {
                cb('Error: ' + data, null);
            }
        });
        req.on('error', (error) => {
            cb('error: ' + error, null);
        });
    }
    set_human_task(body, cb) {
        console.log(body);
        let url = '';
        if (body.status === 'busy') {
            url = 'http://' + this.scheduler_host + ':3210/task/' + body.workflowId + '/' + body.taskId + '/busy';
        }
        else {
            url = 'http://' + this.scheduler_host + ':3210/task/' + body.workflowId + '/' + body.taskId;
        }
        const req = this.client.post(url, (data, response) => {
            if (response.statusCode === 200) {
                this.update_human_tasks(0);
                cb(null, data);
            }
            else {
                cb('Error: ' + data, null);
            }
        });
        req.on('error', (error) => {
            cb('error: ' + error, null);
        });
    }
    check_status() {
        return this.status;
    }
    ;
    get_info() {
        return this.info;
    }
    get_human_tasks() {
        return this.humanTasks;
    }
}
exports.Scheduler = Scheduler;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21wb25lbnRzL3NjaGVkdWxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSx3QkFBd0I7OztBQUV4QjtJQUFBO1FBQ0ksV0FBTSxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUM1QyxXQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDM0IsbUJBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxXQUFXLENBQUM7UUFDM0QsV0FBTSxHQUFHO1lBQ0wsT0FBTyxFQUFFLGlCQUFpQjtZQUMxQixVQUFVLEVBQUUsR0FBRztTQUNsQixDQUFDO1FBQ0YsU0FBSSxHQUFRLEVBQUUsQ0FBQztRQUNmLGVBQVUsR0FBVSxFQUFFLENBQUM7SUErSTNCLENBQUM7SUE3SUcsYUFBYSxDQUFDLFFBQWdCO1FBQzFCLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDN0IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMzQixJQUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUVELGtCQUFrQixDQUFDLFFBQWdCO1FBQy9CLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsY0FBYyxHQUFHLG1CQUFtQixFQUFFLENBQUMsSUFBUyxFQUFFLFFBQWE7WUFDeEcsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLFVBQVUsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUM5QixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztZQUMzQixDQUFDO1lBQ0QsRUFBRSxDQUFDLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2YsVUFBVSxDQUFDLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxF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LENBQUM7UUFFRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFTLEVBQUUsUUFBYTtZQUN2RCxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsVUFBVSxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQzlCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDM0IsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNuQixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ0osRUFBRSxDQUFDLFNBQVMsR0FBRyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDL0IsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFVO1lBQ3ZCLEVBQUUsQ0FBQyxTQUFTLEdBQUcsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2hDLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELFlBQVk7UUFDUixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN2QixDQUFDO0lBQUEsQ0FBQztJQUVGLFFBQVE7UUFDSixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztJQUNyQixDQUFDO0lBRUQsZUFBZTtRQUNYLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO0lBQzNCLENBQUM7Q0FDSjtBQXhKRCw4QkF3SkMiLCJmaWxlIjoic3JjL2NvbXBvbmVudHMvc2NoZWR1bGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypqc2hpbnQgZXN2ZXJzaW9uOiA2ICovXHJcblxyXG5leHBvcnQgY2xhc3MgU2NoZWR1bGVyIHtcclxuICAgIENsaWVudCA9IHJlcXVpcmUoJ25vZGUtcmVzdC1jbGllbnQnKS5DbGllbnQ7XHJcbiAgICBjbGllbnQgPSBuZXcgdGhpcy5DbGllbnQoKTtcclxuICAgIHNjaGVkdWxlcl9ob3N0ID0gcHJvY2Vzcy5lbnYuU0NIRURVTEVSX0hPU1QgfHwgJ2xvY2FsaG9zdCc7XHJcbiAgICBzdGF0dXMgPSB7XHJcbiAgICAgICAgbWVzc2FnZTogJ25vdCB1cGRhdGVkIHlldCcsXHJcbiAgICAgICAgc3RhdHVzQ29kZTogNTAwXHJcbiAgICB9O1xyXG4gICAgaW5mbzogYW55ID0ge307XHJcbiAgICBodW1hblRhc2tzOiBhbnlbXSA9IFtdO1xyXG5cclxuICAgIHN0YXJ0X3VwZGF0ZXMoaW50ZXJ2YWw6IG51bWJlcikge1xyXG4gICAgICAgIHRoaXMudXBkYXRlX3N0YXR1cyhpbnRlcnZhbCk7XHJcbiAgICAgICAgdGhpcy51cGRhdGVfaW5mbyhpbnRlcnZhbCk7XHJcbiAgICAgICAgdGhpcy51cGRhdGVfaHVtYW5fdGFza3MoaW50ZXJ2YWwpO1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZV9odW1hbl90YXNrcyhpbnRlcnZhbDogbnVtYmVyKSB7XHJcbiAgICAgICAgY29uc3QgcmVxID0gdGhpcy5jbGllbnQuZ2V0KCdodHRwOi8vJyArIHRoaXMuc2NoZWR1bGVyX2hvc3QgKyAnOjMyMTAvdGFza3MvaHVtYW4nLCAoZGF0YTogYW55LCByZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID09PSAyMDApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaHVtYW5UYXNrcyA9IGRhdGE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGludGVydmFsID4gMCkge1xyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnVwZGF0ZV9odW1hbl90YXNrcyhpbnRlcnZhbCksIGludGVydmFsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXEub24oJ2Vycm9yJywgKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKGludGVydmFsID4gMCkge1xyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnVwZGF0ZV9odW1hbl90YXNrcyhpbnRlcnZhbCksIGludGVydmFsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZV9zdGF0dXMoaW50ZXJ2YWw6IG51bWJlcikge1xyXG4gICAgICAgIGNvbnN0IHJlcSA9IHRoaXMuY2xpZW50LmdldCgnaHR0cDovLycgKyB0aGlzLnNjaGVkdWxlcl9ob3N0ICsgJzozMjEwL3N0YXR1cycsXHJcbiAgICAgICAgICAgIChkYXRhOiBhbnksIHJlc3BvbnNlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5zdGF0dXMuc3RhdHVzQ29kZSA9IHJlc3BvbnNlLnN0YXR1c0NvZGU7XHJcbiAgICAgICAgICAgIHRoaXMuc3RhdHVzLm1lc3NhZ2UgPSByZXNwb25zZS5zdGF0dXNNZXNzYWdlO1xyXG5cclxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnVwZGF0ZV9zdGF0dXMoaW50ZXJ2YWwpLCBpbnRlcnZhbCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJlcS5vbignZXJyb3InLCAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnN0YXR1cy5zdGF0dXNDb2RlID0gNTAwO1xyXG4gICAgICAgICAgICB0aGlzLnN0YXR1cy5tZXNzYWdlID0gZXJyb3IuY29kZTtcclxuXHJcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy51cGRhdGVfc3RhdHVzKGludGVydmFsKSwgaW50ZXJ2YWwpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZV9pbmZvKGludGVydmFsOiBudW1iZXIpIHtcclxuICAgICAgICBjb25zdCByZXEgPSB0aGlzLmNsaWVudC5nZXQoJ2h0dHA6Ly8nICsgdGhpcy5zY2hlZHVsZXJfaG9zdCArICc6MzIxMC9pbmZvJywgKGRhdGE6IGFueSwgcmVzcG9uc2U6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmluZm8gPSBkYXRhO1xyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnVwZGF0ZV9pbmZvKGludGVydmFsKSwgaW50ZXJ2YWwpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnVwZGF0ZV9pbmZvKGludGVydmFsKSwgaW50ZXJ2YWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJlcS5vbignZXJyb3InLCAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMudXBkYXRlX2luZm8oaW50ZXJ2YWwpLCBpbnRlcnZhbCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0X3BvbGljeShib2R5OiBhbnksIGNiOiBhbnkpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhib2R5KTtcclxuICAgICAgICBjb25zdCByZXEgPSB0aGlzLmNsaWVudC5wb3N0KCdodHRwOi8vJyArIHRoaXMuc2NoZWR1bGVyX2hvc3QgKyAnOjMyMTAvcG9saWN5LycgKyBib2R5LnBvbGljeSxcclxuICAgICAgICAgICAgKGRhdGE6IGFueSwgcmVzcG9uc2U6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgICBjYihudWxsLCBkYXRhKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNiKCdFcnJvcjogJyArIGRhdGEsIG51bGwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJlcS5vbignZXJyb3InLCAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBjYignZXJyb3I6ICcgKyBlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0X2Ftb3VudChib2R5OiBhbnksIGNiOiBhbnkpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhib2R5KTtcclxuICAgICAgICBjb25zdCByZXEgPSB0aGlzLmNsaWVudC5wb3N0KCdodHRwOi8vJyArIHRoaXMuc2NoZWR1bGVyX2hvc3QgKyAnOjMyMTAvYW1vdW50LycgKyBib2R5LnBvbGljeSArICcvJyArIGJvZHkuYW1vdW50LFxyXG4gICAgICAgICAgICAoZGF0YTogYW55LCByZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID09PSAyMDApIHtcclxuICAgICAgICAgICAgICAgIGNiKG51bGwsIGRhdGEpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY2IoJ0Vycm9yOiAnICsgZGF0YSwgbnVsbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmVxLm9uKCdlcnJvcicsIChlcnJvcjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGNiKCdlcnJvcjogJyArIGVycm9yLCBudWxsKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBleGVjdXRlKGJvZHk6IGFueSwgY2I6IGFueSkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGJvZHkpO1xyXG4gICAgICAgIGNvbnN0IGFyZ3MgPSB7XHJcbiAgICAgICAgICAgIGRhdGE6IGJvZHksXHJcbiAgICAgICAgICAgIGhlYWRlcnM6IHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBjb25zdCByZXEgPSB0aGlzLmNsaWVudC5wb3N0KCdodHRwOi8vJyArIHRoaXMuc2NoZWR1bGVyX2hvc3QgKyAnOjMyMTAvZXhlY3V0ZS8nLCBhcmdzLFxyXG4gICAgICAgIChkYXRhOiBhbnksIHJlc3BvbnNlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDIwMCkge1xyXG4gICAgICAgICAgICAgICAgY2IobnVsbCwgZGF0YSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjYignRXJyb3I6ICcgKyBkYXRhLCBudWxsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXEub24oJ2Vycm9yJywgKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgY2IoJ2Vycm9yOiAnICsgZXJyb3IsIG51bGwpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHNldF9odW1hbl90YXNrKGJvZHk6IGFueSwgY2I6IGFueSkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGJvZHkpO1xyXG4gICAgICAgIGxldCB1cmwgPSAnJztcclxuICAgICAgICBpZiAoYm9keS5zdGF0dXMgPT09ICdidXN5Jykge1xyXG4gICAgICAgICAgICB1cmwgPSAnaHR0cDovLycgKyB0aGlzLnNjaGVkdWxlcl9ob3N0ICsgJzozMjEwL3Rhc2svJyArIGJvZHkud29ya2Zsb3dJZCArICcvJyArIGJvZHkudGFza0lkICsgJy9idXN5JztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB1cmwgPSAnaHR0cDovLycgKyB0aGlzLnNjaGVkdWxlcl9ob3N0ICsgJzozMjEwL3Rhc2svJyArIGJvZHkud29ya2Zsb3dJZCArICcvJyArIGJvZHkudGFza0lkO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcmVxID0gdGhpcy5jbGllbnQucG9zdCh1cmwsIChkYXRhOiBhbnksIHJlc3BvbnNlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDIwMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVfaHVtYW5fdGFza3MoMCk7XHJcbiAgICAgICAgICAgICAgICBjYihudWxsLCBkYXRhKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNiKCdFcnJvcjogJyArIGRhdGEsIG51bGwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJlcS5vbignZXJyb3InLCAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBjYignZXJyb3I6ICcgKyBlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY2hlY2tfc3RhdHVzKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnN0YXR1cztcclxuICAgIH07XHJcblxyXG4gICAgZ2V0X2luZm8oKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaW5mbztcclxuICAgIH1cclxuXHJcbiAgICBnZXRfaHVtYW5fdGFza3MoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaHVtYW5UYXNrcztcclxuICAgIH1cclxufVxyXG4iXX0=
