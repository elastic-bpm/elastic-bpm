/*jshint esversion: 6 */
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class Workflow {
    constructor() {
        this.Client = require('node-rest-client').Client;
        this.multiparty = require('multiparty');
        this.fs = require('fs');
        this.client = new this.Client();
        this.workflow_host = process.env.API_HOST || 'localhost';
        this.status = {
            message: 'not updated yet',
            statusCode: 500
        };
        this.workflows = [];
    }
    start_updates(interval) {
        this.update_status(interval);
        this.update_workflows(interval);
    }
    update_status(interval) {
        const req = this.client.get('http://' + this.workflow_host + ':3000/status', (data, response) => {
            this.status.statusCode = response.statusCode;
            this.status.message = response.statusMessage;
            setTimeout(() => this.update_status(interval), interval);
        });
        req.on('error', (error) => {
            this.status.statusCode = 500;
            this.status.message = error.code;
            setTimeout(() => this.update_status(interval), interval);
        });
    }
    update_workflows(interval) {
        const req = this.client.get('http://' + this.workflow_host + ':3000/workflows', (data, response) => {
            this.workflows = data;
            setTimeout(() => this.update_workflows(interval), interval);
        });
        req.on('error', (error) => {
            this.status.statusCode = 500;
            this.status.message = error.code;
            setTimeout(() => this.update_workflows(interval), interval);
        });
    }
    create_workflow(body) {
        const args = {
            data: body,
            headers: { 'Content-Type': 'application/json' }
        };
        return new Promise((resolve, reject) => {
            const req = this.client.post('http://' + this.workflow_host + ':3000/workflows', args, (data, response) => {
                resolve(data);
            });
            req.on('error', (error) => {
                reject(error);
            });
        });
    }
    ;
    delete_workflow(workflowId, cb) {
        const req = this.client.delete('http://' + this.workflow_host + ':3000/workflows/' + workflowId, (data, response) => {
            cb(null, data);
        });
        req.on('error', (error) => {
            cb(error, null);
        });
    }
    delete_all_workflows(body, cb) {
        const req = this.client.delete('http://' + this.workflow_host + ':3000/workflows', (data, response) => {
            cb(null, data);
        });
        req.on('error', (error) => {
            cb(error, null);
        });
    }
    get_workflows_from_file(req, cb) {
        const form = new this.multiparty.Form();
        form.parse(req, (err, fields, files) => {
            if (err) {
                cb(err, null);
            }
            else if (files === undefined || files.workflow === undefined) {
                cb('Error creating workflow, file not found.', null);
            }
            else {
                let workflowsFromFile = {};
                try {
                    workflowsFromFile = JSON.parse(this.fs.readFileSync(files.workflow[0].path, 'utf8'));
                    this.fs.unlink(files.workflow[0].path, (unlink_err) => {
                        if (unlink_err) {
                            cb(unlink_err, null);
                        }
                        else {
                            cb(null, workflowsFromFile);
                        }
                    });
                }
                catch (e) {
                    cb(e, null);
                }
            }
        });
    }
    ;
    create_workflows_from_file(req, cb) {
        this.get_workflows_from_file(req, (error, workflows) => {
            if (error) {
                cb(error, null);
            }
            else {
                if (workflows.length === 0) {
                    cb('No workflows to create!', null);
                }
                const args = {
                    data: workflows,
                    headers: { 'Content-Type': 'application/json' }
                };
                const req2 = this.client.post('http://' + this.workflow_host + ':3000/workflows/multiple', args, (data, response) => {
                    if (response.statusCode === 200) {
                        cb(null, data);
                    }
                });
                req2.on('error', (err) => {
                    cb('' + err, null);
                });
            }
        });
    }
    check_status() {
        return this.status;
    }
    ;
    get_workflows() {
        return this.workflows;
    }
    ;
}
exports.Workflow = Workflow;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21wb25lbnRzL3dvcmtmbG93cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSx3QkFBd0I7OztBQUV4QjtJQUFBO1FBQ0ksV0FBTSxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUM1QyxlQUFVLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ25DLE9BQUUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbkIsV0FBTSxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQzNCLGtCQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksV0FBVyxDQUFDO1FBQ3BELFdBQU0sR0FBRztZQUNMLE9BQU8sRUFBRSxpQkFBaUI7WUFDMUIsVUFBVSxFQUFFLEdBQUc7U0FDbEIsQ0FBQztRQUNGLGNBQVMsR0FBVSxFQUFFLENBQUM7SUEwSTFCLENBQUM7SUF4SUcsYUFBYSxDQUFDLFFBQWE7UUFDdkIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELGFBQWEsQ0FBQyxRQUFhO1FBQ3ZCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsYUFBYSxHQUFHLGNBQWMsRUFDdkUsQ0FBQyxJQUFTLEVBQUUsUUFBYTtZQUNyQixJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsR0FBRyxRQUFRLENBQUMsVUFBVSxDQUFDO1lBQzdDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUM7WUFFN0MsVUFBVSxDQUFDLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUM3RCxDQUFDLENBQUMsQ0FB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O2dCQUNMLENBQUMsQ0FBQyxDQUFDO2dCQUVQLElBQUksQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBUTtvQkFDdEIsRUFBRSxDQUFDLEVBQUUsR0FBRyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQ3ZCLENBQUMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELFlBQVk7UUFDUixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN2QixDQUFDO0lBQUEsQ0FBQztJQUVGLGFBQWE7UUFDVCxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUMxQixDQUFDO0lBQUEsQ0FBQztDQUNMO0FBcEpELDRCQW9KQyIsImZpbGUiOiJzcmMvY29tcG9uZW50cy93b3JrZmxvd3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKmpzaGludCBlc3ZlcnNpb246IDYgKi9cclxuXHJcbmV4cG9ydCBjbGFzcyBXb3JrZmxvdyB7XHJcbiAgICBDbGllbnQgPSByZXF1aXJlKCdub2RlLXJlc3QtY2xpZW50JykuQ2xpZW50O1xyXG4gICAgbXVsdGlwYXJ0eSA9IHJlcXVpcmUoJ211bHRpcGFydHknKTtcclxuICAgIGZzID0gcmVxdWlyZSgnZnMnKTtcclxuICAgIGNsaWVudCA9IG5ldyB0aGlzLkNsaWVudCgpO1xyXG4gICAgd29ya2Zsb3dfaG9zdCA9IHByb2Nlc3MuZW52LkFQSV9IT1NUIHx8ICdsb2NhbGhvc3QnO1xyXG4gICAgc3RhdHVzID0ge1xyXG4gICAgICAgIG1lc3NhZ2U6ICdub3QgdXBkYXRlZCB5ZXQnLFxyXG4gICAgICAgIHN0YXR1c0NvZGU6IDUwMFxyXG4gICAgfTtcclxuICAgIHdvcmtmbG93czogYW55W10gPSBbXTtcclxuXHJcbiAgICBzdGFydF91cGRhdGVzKGludGVydmFsOiBhbnkpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZV9zdGF0dXMoaW50ZXJ2YWwpO1xyXG4gICAgICAgIHRoaXMudXBkYXRlX3dvcmtmbG93cyhpbnRlcnZhbCk7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlX3N0YXR1cyhpbnRlcnZhbDogYW55KSB7XHJcbiAgICAgICAgY29uc3QgcmVxID0gdGhpcy5jbGllbnQuZ2V0KCdodHRwOi8vJyArIHRoaXMud29ya2Zsb3dfaG9zdCArICc6MzAwMC9zdGF0dXMnLFxyXG4gICAgICAgICAgICAoZGF0YTogYW55LCByZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cy5zdGF0dXNDb2RlID0gcmVzcG9uc2Uuc3RhdHVzQ29kZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLm1lc3NhZ2UgPSByZXNwb25zZS5zdGF0dXNNZXNzYWdlO1xyXG5cclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy51cGRhdGVfc3RhdHVzKGludGVydmFsKSwgaW50ZXJ2YWwpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmVxLm9uKCdlcnJvcicsIChlcnJvcjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuc3RhdHVzLnN0YXR1c0NvZGUgPSA1MDA7XHJcbiAgICAgICAgICAgIHRoaXMuc3RhdHVzLm1lc3NhZ2UgPSBlcnJvci5jb2RlO1xyXG5cclxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnVwZGF0ZV9zdGF0dXMoaW50ZXJ2YWwpLCBpbnRlcnZhbCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlX3dvcmtmbG93cyhpbnRlcnZhbDogYW55KSB7XHJcbiAgICAgICAgY29uc3QgcmVxID0gdGhpcy5jbGllbnQuZ2V0KCdodHRwOi8vJyArIHRoaXMud29ya2Zsb3dfaG9zdCArICc6MzAwMC93b3JrZmxvd3MnLFxyXG4gICAgICAgICAgICAoZGF0YTogYW55LCByZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLndvcmtmbG93cyA9IGRhdGE7XHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMudXBkYXRlX3dvcmtmbG93cyhpbnRlcnZhbCksIGludGVydmFsKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJlcS5vbignZXJyb3InLCAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnN0YXR1cy5zdGF0dXNDb2RlID0gNTAwO1xyXG4gICAgICAgICAgICB0aGlzLnN0YXR1cy5tZXNzYWdlID0gZXJyb3IuY29kZTtcclxuXHJcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy51cGRhdGVfd29ya2Zsb3dzKGludGVydmFsKSwgaW50ZXJ2YWwpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNyZWF0ZV93b3JrZmxvdyhib2R5OiBhbnkpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgICAgIGNvbnN0IGFyZ3MgPSB7XHJcbiAgICAgICAgICAgIGRhdGE6IGJvZHksXHJcbiAgICAgICAgICAgIGhlYWRlcnM6IHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCByZXEgPSB0aGlzLmNsaWVudC5wb3N0KCdodHRwOi8vJyArIHRoaXMud29ya2Zsb3dfaG9zdCArICc6MzAwMC93b3JrZmxvd3MnLCBhcmdzLFxyXG4gICAgICAgICAgICAgICAgKGRhdGE6IGFueSwgcmVzcG9uc2U6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHJlcS5vbignZXJyb3InLCAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGRlbGV0ZV93b3JrZmxvdyh3b3JrZmxvd0lkOiBhbnksIGNiOiBhbnkpIHtcclxuICAgICAgICBjb25zdCByZXEgPSB0aGlzLmNsaWVudC5kZWxldGUoJ2h0dHA6Ly8nICsgdGhpcy53b3JrZmxvd19ob3N0ICsgJzozMDAwL3dvcmtmbG93cy8nICsgd29ya2Zsb3dJZCxcclxuICAgICAgICAgICAgKGRhdGE6IGFueSwgcmVzcG9uc2U6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY2IobnVsbCwgZGF0YSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXEub24oJ2Vycm9yJywgKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgY2IoZXJyb3IsIG51bGwpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGRlbGV0ZV9hbGxfd29ya2Zsb3dzKGJvZHk6IGFueSwgY2I6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IHJlcSA9IHRoaXMuY2xpZW50LmRlbGV0ZSgnaHR0cDovLycgKyB0aGlzLndvcmtmbG93X2hvc3QgKyAnOjMwMDAvd29ya2Zsb3dzJyxcclxuICAgICAgICAgICAgKGRhdGE6IGFueSwgcmVzcG9uc2U6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY2IobnVsbCwgZGF0YSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXEub24oJ2Vycm9yJywgKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgY2IoZXJyb3IsIG51bGwpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGdldF93b3JrZmxvd3NfZnJvbV9maWxlKHJlcTogYW55LCBjYjogYW55KSB7XHJcbiAgICAgICAgY29uc3QgZm9ybSA9IG5ldyB0aGlzLm11bHRpcGFydHkuRm9ybSgpO1xyXG4gICAgICAgIGZvcm0ucGFyc2UocmVxLCAoZXJyOiBhbnksIGZpZWxkczogYW55LCBmaWxlczogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgIGNiKGVyciwgbnVsbCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlsZXMgPT09IHVuZGVmaW5lZCB8fCBmaWxlcy53b3JrZmxvdyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBjYignRXJyb3IgY3JlYXRpbmcgd29ya2Zsb3csIGZpbGUgbm90IGZvdW5kLicsIG51bGwpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbGV0IHdvcmtmbG93c0Zyb21GaWxlID0ge307XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIHdvcmtmbG93c0Zyb21GaWxlID0gSlNPTi5wYXJzZSh0aGlzLmZzLnJlYWRGaWxlU3luYyhmaWxlcy53b3JrZmxvd1swXS5wYXRoLCAndXRmOCcpKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmZzLnVubGluayhmaWxlcy53b3JrZmxvd1swXS5wYXRoLCAodW5saW5rX2VycjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmxpbmtfZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYih1bmxpbmtfZXJyLCBudWxsKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIHdvcmtmbG93c0Zyb21GaWxlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKGUsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGNyZWF0ZV93b3JrZmxvd3NfZnJvbV9maWxlKHJlcTogYW55LCBjYjogYW55KSB7XHJcbiAgICAgICAgdGhpcy5nZXRfd29ya2Zsb3dzX2Zyb21fZmlsZShyZXEsIChlcnJvcjogYW55LCB3b3JrZmxvd3M6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIGNiKGVycm9yLCBudWxsKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmICh3b3JrZmxvd3MubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2IoJ05vIHdvcmtmbG93cyB0byBjcmVhdGUhJywgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgYXJncyA9IHtcclxuICAgICAgICAgICAgICAgICAgICBkYXRhOiB3b3JrZmxvd3MsXHJcbiAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXEyID0gdGhpcy5jbGllbnQucG9zdCgnaHR0cDovLycgKyB0aGlzLndvcmtmbG93X2hvc3QgKyAnOjMwMDAvd29ya2Zsb3dzL211bHRpcGxlJywgYXJncyxcclxuICAgICAgICAgICAgICAgICAgICAoZGF0YTogYW55LCByZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID09PSAyMDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgcmVxMi5vbignZXJyb3InLCAoZXJyOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjYignJyArIGVyciwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNoZWNrX3N0YXR1cygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zdGF0dXM7XHJcbiAgICB9O1xyXG5cclxuICAgIGdldF93b3JrZmxvd3MoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMud29ya2Zsb3dzO1xyXG4gICAgfTtcclxufVxyXG4iXX0=
