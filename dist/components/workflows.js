/*jshint esversion: 6 */
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class Workflow {
    constructor() {
        this.Client = require('node-rest-client').Client;
        this.multiparty = require('multiparty');
        this.fs = require('fs');
        this.client = new this.Client();
        this.workflow_host = process.env.API_HOST || 'localhost';
        this.status = {
            message: 'not updated yet',
            statusCode: 500
        };
        this.workflows = [];
    }
    start_updates(interval) {
        this.update_status(interval);
        this.update_workflows(interval);
    }
    update_status(interval) {
        const req = this.client.get('http://' + this.workflow_host + ':3000/status', (data, response) => {
            this.status.statusCode = response.statusCode;
            this.status.message = response.statusMessage;
            setTimeout(() => this.update_status(interval), interval);
        });
        req.on('error', (error) => {
            this.status.statusCode = 500;
            this.status.message = error.code;
            setTimeout(() => this.update_status(interval), interval);
        });
    }
    update_workflows(interval) {
        const req = this.client.get('http://' + this.workflow_host + ':3000/workflows', (data, response) => {
            this.workflows = data;
            setTimeout(() => this.update_workflows(interval), interval);
        });
        req.on('error', (error) => {
            this.status.statusCode = 500;
            this.status.message = error.code;
            setTimeout(() => this.update_workflows(interval), interval);
        });
    }
    create_workflow(body) {
        const args = {
            data: body,
            headers: { 'Content-Type': 'application/json' }
        };
        return new Promise((resolve, reject) => {
            const req = this.client.post('http://' + this.workflow_host + ':3000/workflows', args, (data, response) => {
                resolve(data);
            });
            req.on('error', (error) => {
                reject(error);
            });
        });
    }
    ;
    delete_workflow(workflowId, cb) {
        const req = this.client.delete('http://' + this.workflow_host + ':3000/workflows/' + workflowId, (data, response) => {
            cb(null, data);
        });
        req.on('error', (error) => {
            cb(error, null);
        });
    }
    delete_all_workflows(body, cb) {
        const req = this.client.delete('http://' + this.workflow_host + ':3000/workflows', (data, response) => {
            cb(null, data);
        });
        req.on('error', (error) => {
            cb(error, null);
        });
    }
    get_workflows_from_file(req, cb) {
        const form = new this.multiparty.Form();
        form.parse(req, (err, fields, files) => {
            if (err) {
                cb(err, null);
            }
            else if (files === undefined || files.workflow === undefined) {
                cb('Error creating workflow, file not found.', null);
            }
            else {
                let workflowsFromFile = {};
                try {
                    workflowsFromFile = JSON.parse(this.fs.readFileSync(files.workflow[0].path, 'utf8'));
                    this.fs.unlink(files.workflow[0].path, (unlink_err) => {
                        if (unlink_err) {
                            cb(unlink_err, null);
                        }
                        else {
                            cb(null, workflowsFromFile);
                        }
                    });
                }
                catch (e) {
                    cb(e, null);
                }
            }
        });
    }
    ;
    create_workflows_from_file(req, cb) {
        this.get_workflows_from_file(req, (error, workflows) => {
            if (error) {
                cb(error, null);
            }
            else {
                if (workflows.length === 0) {
                    cb('No workflows to create!', null);
                }
                const args = {
                    data: workflows,
                    headers: { 'Content-Type': 'application/json' }
                };
                const req2 = this.client.post('http://' + this.workflow_host + ':3000/workflows/multiple', args, (data, response) => {
                    if (response.statusCode === 200) {
                        cb(null, data);
                    }
                });
                req2.on('error', (err) => {
                    cb('' + err, null);
                });
            }
        });
    }
    check_status() {
        return this.status;
    }
    ;
    get_workflows() {
        return this.workflows;
    }
    ;
}
exports.Workflow = Workflow;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21wb25lbnRzL3dvcmtmbG93cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSx3QkFBd0I7OztBQUV4QjtJQUFBO1FBQ0ksV0FBTSxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUM1QyxlQUFVLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ25DLE9BQUUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbkIsV0FBTSxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQzNCLGtCQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksV0FBVyxDQUFDO1FBQ3BELFdBQU0sR0FBRztZQUNMLE9BQU8sRUFBRSxpQkFBaUI7WUFDMUIsVUFBVSxFQUFFLEdBQUc7U0FDbEIsQ0FBQztRQUNGLGNBQVMsR0FBVSxFQUFFLENBQUM7SUEwSTFCLENBQUM7SUF4SUcsYUFBYSxDQUFDLFFBQWE7UUFDdkIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELGFBQWEsQ0FBQyxRQUFhO1FBQ3ZCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsYUFBYSxHQUFHLGNBQWMsRUFDdkUsQ0FBQyxJQUFTLEVBQUUsUUFBYTtZQUNyQixJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsR0FBRyxRQUFRLENBQUMsVUFBVSxDQUFDO1lBQzdDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUM7WUFFN0MsVUFBVSxDQUFDLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUM3RCxDQUFDLENBQUMsQ0FB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O2dCQUNMLENBQUMsQ0FBQyxDQUFDO2dCQUVQLElBQUksQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBUTtvQkFDdEIsRUFBRSxDQUFDLEVBQUUsR0FBRyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQ3ZCLENBQUMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELFlBQVk7UUFDUixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN2QixDQUFDO0lBQUEsQ0FBQztJQUVGLGFBQWE7UUFDVCxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUMxQixDQUFDO0lBQUEsQ0FBQztDQUNMO0FBcEpELDRCQW9KQyIsImZpbGUiOiJjb21wb25lbnRzL3dvcmtmbG93cy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qanNoaW50IGVzdmVyc2lvbjogNiAqL1xyXG5cclxuZXhwb3J0IGNsYXNzIFdvcmtmbG93IHtcclxuICAgIENsaWVudCA9IHJlcXVpcmUoJ25vZGUtcmVzdC1jbGllbnQnKS5DbGllbnQ7XHJcbiAgICBtdWx0aXBhcnR5ID0gcmVxdWlyZSgnbXVsdGlwYXJ0eScpO1xyXG4gICAgZnMgPSByZXF1aXJlKCdmcycpO1xyXG4gICAgY2xpZW50ID0gbmV3IHRoaXMuQ2xpZW50KCk7XHJcbiAgICB3b3JrZmxvd19ob3N0ID0gcHJvY2Vzcy5lbnYuQVBJX0hPU1QgfHwgJ2xvY2FsaG9zdCc7XHJcbiAgICBzdGF0dXMgPSB7XHJcbiAgICAgICAgbWVzc2FnZTogJ25vdCB1cGRhdGVkIHlldCcsXHJcbiAgICAgICAgc3RhdHVzQ29kZTogNTAwXHJcbiAgICB9O1xyXG4gICAgd29ya2Zsb3dzOiBhbnlbXSA9IFtdO1xyXG5cclxuICAgIHN0YXJ0X3VwZGF0ZXMoaW50ZXJ2YWw6IGFueSkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlX3N0YXR1cyhpbnRlcnZhbCk7XHJcbiAgICAgICAgdGhpcy51cGRhdGVfd29ya2Zsb3dzKGludGVydmFsKTtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVfc3RhdHVzKGludGVydmFsOiBhbnkpIHtcclxuICAgICAgICBjb25zdCByZXEgPSB0aGlzLmNsaWVudC5nZXQoJ2h0dHA6Ly8nICsgdGhpcy53b3JrZmxvd19ob3N0ICsgJzozMDAwL3N0YXR1cycsXHJcbiAgICAgICAgICAgIChkYXRhOiBhbnksIHJlc3BvbnNlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzLnN0YXR1c0NvZGUgPSByZXNwb25zZS5zdGF0dXNDb2RlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMubWVzc2FnZSA9IHJlc3BvbnNlLnN0YXR1c01lc3NhZ2U7XHJcblxyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnVwZGF0ZV9zdGF0dXMoaW50ZXJ2YWwpLCBpbnRlcnZhbCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXEub24oJ2Vycm9yJywgKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5zdGF0dXMuc3RhdHVzQ29kZSA9IDUwMDtcclxuICAgICAgICAgICAgdGhpcy5zdGF0dXMubWVzc2FnZSA9IGVycm9yLmNvZGU7XHJcblxyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMudXBkYXRlX3N0YXR1cyhpbnRlcnZhbCksIGludGVydmFsKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVfd29ya2Zsb3dzKGludGVydmFsOiBhbnkpIHtcclxuICAgICAgICBjb25zdCByZXEgPSB0aGlzLmNsaWVudC5nZXQoJ2h0dHA6Ly8nICsgdGhpcy53b3JrZmxvd19ob3N0ICsgJzozMDAwL3dvcmtmbG93cycsXHJcbiAgICAgICAgICAgIChkYXRhOiBhbnksIHJlc3BvbnNlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMud29ya2Zsb3dzID0gZGF0YTtcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy51cGRhdGVfd29ya2Zsb3dzKGludGVydmFsKSwgaW50ZXJ2YWwpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmVxLm9uKCdlcnJvcicsIChlcnJvcjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuc3RhdHVzLnN0YXR1c0NvZGUgPSA1MDA7XHJcbiAgICAgICAgICAgIHRoaXMuc3RhdHVzLm1lc3NhZ2UgPSBlcnJvci5jb2RlO1xyXG5cclxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnVwZGF0ZV93b3JrZmxvd3MoaW50ZXJ2YWwpLCBpbnRlcnZhbCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY3JlYXRlX3dvcmtmbG93KGJvZHk6IGFueSk6IFByb21pc2U8YW55PiB7XHJcbiAgICAgICAgY29uc3QgYXJncyA9IHtcclxuICAgICAgICAgICAgZGF0YTogYm9keSxcclxuICAgICAgICAgICAgaGVhZGVyczogeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHRoaXMuY2xpZW50LnBvc3QoJ2h0dHA6Ly8nICsgdGhpcy53b3JrZmxvd19ob3N0ICsgJzozMDAwL3dvcmtmbG93cycsIGFyZ3MsXHJcbiAgICAgICAgICAgICAgICAoZGF0YTogYW55LCByZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgcmVxLm9uKCdlcnJvcicsIChlcnJvcjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZGVsZXRlX3dvcmtmbG93KHdvcmtmbG93SWQ6IGFueSwgY2I6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IHJlcSA9IHRoaXMuY2xpZW50LmRlbGV0ZSgnaHR0cDovLycgKyB0aGlzLndvcmtmbG93X2hvc3QgKyAnOjMwMDAvd29ya2Zsb3dzLycgKyB3b3JrZmxvd0lkLFxyXG4gICAgICAgICAgICAoZGF0YTogYW55LCByZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjYihudWxsLCBkYXRhKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJlcS5vbignZXJyb3InLCAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZGVsZXRlX2FsbF93b3JrZmxvd3MoYm9keTogYW55LCBjYjogYW55KSB7XHJcbiAgICAgICAgY29uc3QgcmVxID0gdGhpcy5jbGllbnQuZGVsZXRlKCdodHRwOi8vJyArIHRoaXMud29ya2Zsb3dfaG9zdCArICc6MzAwMC93b3JrZmxvd3MnLFxyXG4gICAgICAgICAgICAoZGF0YTogYW55LCByZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjYihudWxsLCBkYXRhKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJlcS5vbignZXJyb3InLCAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0X3dvcmtmbG93c19mcm9tX2ZpbGUocmVxOiBhbnksIGNiOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBmb3JtID0gbmV3IHRoaXMubXVsdGlwYXJ0eS5Gb3JtKCk7XHJcbiAgICAgICAgZm9ybS5wYXJzZShyZXEsIChlcnI6IGFueSwgZmllbGRzOiBhbnksIGZpbGVzOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgY2IoZXJyLCBudWxsKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChmaWxlcyA9PT0gdW5kZWZpbmVkIHx8IGZpbGVzLndvcmtmbG93ID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGNiKCdFcnJvciBjcmVhdGluZyB3b3JrZmxvdywgZmlsZSBub3QgZm91bmQuJywgbnVsbCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgd29ya2Zsb3dzRnJvbUZpbGUgPSB7fTtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3dzRnJvbUZpbGUgPSBKU09OLnBhcnNlKHRoaXMuZnMucmVhZEZpbGVTeW5jKGZpbGVzLndvcmtmbG93WzBdLnBhdGgsICd1dGY4JykpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZnMudW5saW5rKGZpbGVzLndvcmtmbG93WzBdLnBhdGgsICh1bmxpbmtfZXJyOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVubGlua19lcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNiKHVubGlua19lcnIsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgd29ya2Zsb3dzRnJvbUZpbGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2IoZSwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgY3JlYXRlX3dvcmtmbG93c19mcm9tX2ZpbGUocmVxOiBhbnksIGNiOiBhbnkpIHtcclxuICAgICAgICB0aGlzLmdldF93b3JrZmxvd3NfZnJvbV9maWxlKHJlcSwgKGVycm9yOiBhbnksIHdvcmtmbG93czogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgY2IoZXJyb3IsIG51bGwpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKHdvcmtmbG93cy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBjYignTm8gd29ya2Zsb3dzIHRvIGNyZWF0ZSEnLCBudWxsKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBhcmdzID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHdvcmtmbG93cyxcclxuICAgICAgICAgICAgICAgICAgICBoZWFkZXJzOiB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlcTIgPSB0aGlzLmNsaWVudC5wb3N0KCdodHRwOi8vJyArIHRoaXMud29ya2Zsb3dfaG9zdCArICc6MzAwMC93b3JrZmxvd3MvbXVsdGlwbGUnLCBhcmdzLFxyXG4gICAgICAgICAgICAgICAgICAgIChkYXRhOiBhbnksIHJlc3BvbnNlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDIwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXEyLm9uKCdlcnJvcicsIChlcnI6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKCcnICsgZXJyLCBudWxsKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY2hlY2tfc3RhdHVzKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnN0YXR1cztcclxuICAgIH07XHJcblxyXG4gICAgZ2V0X3dvcmtmbG93cygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy53b3JrZmxvd3M7XHJcbiAgICB9O1xyXG59XHJcbiJdfQ==
