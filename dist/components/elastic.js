"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const elasticsearch = require("elasticsearch");
const rx_elasticsearch_1 = require("rx-elasticsearch");
class Elastic {
    constructor() {
        this.elastic_host = process.env.ELASTIC_HOST || '137.116.195.67';
        this.client = new elasticsearch.Client({
            host: this.elastic_host + ':9200',
            log: 'info'
        });
        this.startTime = new Date().getTime(); // NOW
        this.component = {};
        this.messages = [];
        this.rawLoad = [];
        this.maxLoadLength = 10;
        this.status = {
            message: 'not updated yet',
            statusCode: 500
        };
        this.machineLoad = {};
    }
    start_updates(interval) {
        this.update_status(interval);
        this.update_messages(interval);
        this.update_load(interval);
    }
    update_load(interval) {
        let from = this.startTime;
        if (this.rawLoad.length > 0) {
            from = new Date(this.rawLoad[0]['@timestamp']).getTime();
        }
        const query = {
            index: 'metricbeat-*',
            scroll: '30s',
            body: {
                query: {
                    bool: {
                        must: [
                            {
                                query_string: {
                                    analyze_wildcard: true,
                                    query: '*'
                                }
                            },
                            {
                                match: {
                                    'metricset.name': {
                                        query: 'load',
                                        type: 'phrase'
                                    }
                                }
                            },
                            {
                                range: {
                                    '@timestamp': {
                                        gt: from,
                                        format: 'epoch_millis'
                                    }
                                }
                            }
                        ],
                        must_not: new Array()
                    }
                }
            }
        };
        const rxClient = new rx_elasticsearch_1.default(this.client);
        rxClient
            .scroll(query)
            .subscribe((response) => {
            const newLoad = [];
            response.hits.hits.forEach((hit) => {
                newLoad.push(hit._source);
                newLoad.sort(function (a, b) {
                    if (a['@timestamp'] < b['@timestamp']) {
                        return -1;
                    }
                    else {
                        return 1;
                    }
                });
                newLoad.forEach((load) => {
                    if (Object.keys(this.machineLoad).indexOf(load.beat.hostname) !== -1) {
                        this.machineLoad[load.beat.hostname].load1.push(load.system.load['1']);
                        if (this.machineLoad[load.beat.hostname].load1.length > this.maxLoadLength) {
                            this.machineLoad[load.beat.hostname].load1 = this.machineLoad[load.beat.hostname].load1.slice(1);
                        }
                        this.machineLoad[load.beat.hostname].load5.push(load.system.load['5']);
                        if (this.machineLoad[load.beat.hostname].load5.length > this.maxLoadLength) {
                            this.machineLoad[load.beat.hostname].load5 = this.machineLoad[load.beat.hostname].load5.slice(1);
                        }
                        this.machineLoad[load.beat.hostname].load15.push(load.system.load['15']);
                        if (this.machineLoad[load.beat.hostname].load15.length > this.maxLoadLength) {
                            this.machineLoad[load.beat.hostname].load15 = this.machineLoad[load.beat.hostname].load15.slice(1);
                        }
                    }
                    else {
                        this.machineLoad[load.beat.hostname] = {
                            load1: [load.system.load['1']],
                            load5: [load.system.load['5']],
                            load15: [load.system.load['15']],
                        };
                    }
                });
                console.log(newLoad.length);
                if (newLoad.length > 0) {
                    this.rawLoad = newLoad;
                }
                setTimeout(() => { this.update_load(interval); }, interval);
            });
        }, (e) => console.error(e));
    }
    update_messages(interval) {
        let from = this.startTime;
        if (this.messages.length > 0) {
            from = new Date(this.messages[0]['@timestamp']).getTime();
        }
        const messagesQuery = {
            index: 'logstash-*',
            scroll: '30s',
            body: {
                query: {
                    bool: {
                        must: [{
                                query_string: {
                                    query: '*',
                                    analyze_wildcard: true
                                }
                            }, {
                                range: {
                                    '@timestamp': {
                                        gt: from,
                                        format: 'epoch_millis'
                                    }
                                }
                            }]
                    }
                }
            }
        };
        const rxClient = new rx_elasticsearch_1.default(this.client);
        rxClient
            .scroll(messagesQuery)
            .subscribe((response) => {
            const newMessages = [];
            response.hits.hits.forEach((hit) => {
                newMessages.push(hit._source);
            });
            newMessages.sort((a, b) => {
                if (a['@timestamp'] < b['@timestamp']) {
                    return 1;
                }
                else {
                    return -1;
                }
            });
            this.messages = newMessages.concat(this.messages);
            this.messages = this.messages.slice(0, 100);
            setTimeout(() => { this.update_messages(interval); }, interval);
        }, (e) => console.error(e));
    }
    update_status(interval) {
        this.client.ping({
            // ping usually has a 3000ms timeout
            requestTimeout: 1000
        }, (error) => {
            if (error) {
                this.status = {
                    message: 'ELK Down',
                    statusCode: 400
                };
                setTimeout(() => this.update_status(interval), interval);
            }
            else {
                this.status = {
                    message: 'OK',
                    statusCode: 200
                };
                setTimeout(() => this.update_status(interval), interval);
            }
        });
    }
    check_status() {
        return this.status;
    }
    get_messages() {
        return this.messages;
    }
    get_load() {
        return this.machineLoad;
    }
}
exports.Elastic = Elastic;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21wb25lbnRzL2VsYXN0aWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQ0FBK0M7QUFDL0MsdURBQXdDO0FBR3hDO0lBQUE7UUFDSSxpQkFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLGdCQUFnQixDQUFDO1FBQzVELFdBQU0sR0FBRyxJQUFJLGFBQWEsQ0FBQyxNQUFNLENBQUM7WUFDOUIsSUFBSSxFQUFFLElBQUksQ0FBQyxZQUFZLEdBQUcsT0FBTztZQUNqQyxHQUFHLEVBQUUsTUFBTTtTQUNkLENBQUMsQ0FBQztRQUVILGNBQVMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsTUFBTTtRQUV4QyxjQUFTLEdBQVEsRUFBRSxDQUFDO1FBQ3BCLGFBQVEsR0FBVSxFQUFFLENBQUM7UUFDckIsWUFBTyxHQUFVLEVBQUUsQ0FBQztRQUNwQixrQkFBYSxHQUFHLEVBQUUsQ0FBQztRQUVuQixXQUFNLEdBQVE7WUFDVixPQUFPLEVBQUUsaUJBQWlCO1lBQzFCLFVBQVUsRUFBRSxHQUFHO1NBQ2xCLENBQUM7UUFDRixnQkFBVyxHQUFRLEVBQUUsQ0FBQztJQWdNMUIsQ0FBQztJQTlMRyxhQUFhLENBQUMsUUFBZ0I7UUFDMUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQy9CLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVELFdBQVcsQ0FBQyxRQUFnQjtRQUN4QixJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQzFCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDMUIsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFP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Q0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQzs0QkFDekUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDckcsQ0FBQzt3QkFFRCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO3dCQUN6RSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQzs0QkFDMUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDdkcsQ0FBQztvQkFDTCxDQUFDO29CQUFDLElBQUksQ0FBQyxDQUFDO3dCQUNKLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRzs0QkFDbkMsS0FBSyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7NEJBQzlCLEtBQUssRUFBRSxDQUFDLElB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ICogYXMgZWxhc3RpY3NlYXJjaCBmcm9tICdlbGFzdGljc2VhcmNoJztcclxuaW1wb3J0IFJ4Q2xpZW50IGZyb20gJ3J4LWVsYXN0aWNzZWFyY2gnO1xyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBFbGFzdGljIHtcclxuICAgIGVsYXN0aWNfaG9zdCA9IHByb2Nlc3MuZW52LkVMQVNUSUNfSE9TVCB8fCAnMTM3LjExNi4xOTUuNjcnO1xyXG4gICAgY2xpZW50ID0gbmV3IGVsYXN0aWNzZWFyY2guQ2xpZW50KHtcclxuICAgICAgICBob3N0OiB0aGlzLmVsYXN0aWNfaG9zdCArICc6OTIwMCcsXHJcbiAgICAgICAgbG9nOiAnaW5mbydcclxuICAgIH0pO1xyXG5cclxuICAgIHN0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOyAvLyBOT1dcclxuXHJcbiAgICBjb21wb25lbnQ6IGFueSA9IHt9O1xyXG4gICAgbWVzc2FnZXM6IGFueVtdID0gW107XHJcbiAgICByYXdMb2FkOiBhbnlbXSA9IFtdO1xyXG4gICAgbWF4TG9hZExlbmd0aCA9IDEwO1xyXG5cclxuICAgIHN0YXR1czogYW55ID0ge1xyXG4gICAgICAgIG1lc3NhZ2U6ICdub3QgdXBkYXRlZCB5ZXQnLFxyXG4gICAgICAgIHN0YXR1c0NvZGU6IDUwMFxyXG4gICAgfTtcclxuICAgIG1hY2hpbmVMb2FkOiBhbnkgPSB7fTtcclxuXHJcbiAgICBzdGFydF91cGRhdGVzKGludGVydmFsOiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZV9zdGF0dXMoaW50ZXJ2YWwpO1xyXG4gICAgICAgIHRoaXMudXBkYXRlX21lc3NhZ2VzKGludGVydmFsKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZV9sb2FkKGludGVydmFsKTtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVfbG9hZChpbnRlcnZhbDogbnVtYmVyKSB7XHJcbiAgICAgICAgbGV0IGZyb20gPSB0aGlzLnN0YXJ0VGltZTtcclxuICAgICAgICBpZiAodGhpcy5yYXdMb2FkLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgZnJvbSA9IG5ldyBEYXRlKHRoaXMucmF3TG9hZFswXVsnQHRpbWVzdGFtcCddKS5nZXRUaW1lKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBxdWVyeSA9IHtcclxuICAgICAgICAgICAgaW5kZXg6ICdtZXRyaWNiZWF0LSonLFxyXG4gICAgICAgICAgICBzY3JvbGw6ICczMHMnLFxyXG4gICAgICAgICAgICBib2R5OiB7XHJcbiAgICAgICAgICAgICAgICBxdWVyeToge1xyXG4gICAgICAgICAgICAgICAgICAgIGJvb2w6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbXVzdDogW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5X3N0cmluZzoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmFseXplX3dpbGRjYXJkOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVyeTogJyonXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWV0cmljc2V0Lm5hbWUnOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVyeTogJ2xvYWQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3BocmFzZSdcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2U6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0B0aW1lc3RhbXAnOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBndDogZnJvbSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdDogJ2Vwb2NoX21pbGxpcydcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbXVzdF9ub3Q6IG5ldyBBcnJheSgpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY29uc3QgcnhDbGllbnQgPSBuZXcgUnhDbGllbnQodGhpcy5jbGllbnQpO1xyXG4gICAgICAgIHJ4Q2xpZW50XHJcbiAgICAgICAgICAgIC5zY3JvbGwocXVlcnkpXHJcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgIChyZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdMb2FkOiBhbnlbXSA9IFtdO1xyXG5cclxuICAgICAgICAgICAgICAgIHJlc3BvbnNlLmhpdHMuaGl0cy5mb3JFYWNoKChoaXQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld0xvYWQucHVzaChoaXQuX3NvdXJjZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3TG9hZC5zb3J0KGZ1bmN0aW9uIChhOiBhbnksIGI6IGFueSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYVsnQHRpbWVzdGFtcCddIDwgYlsnQHRpbWVzdGFtcCddKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld0xvYWQuZm9yRWFjaCgobG9hZDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyh0aGlzLm1hY2hpbmVMb2FkKS5pbmRleE9mKGxvYWQuYmVhdC5ob3N0bmFtZSkgIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1hY2hpbmVMb2FkW2xvYWQuYmVhdC5ob3N0bmFtZV0ubG9hZDEucHVzaChsb2FkLnN5c3RlbS5sb2FkWycxJ10pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubWFjaGluZUxvYWRbbG9hZC5iZWF0Lmhvc3RuYW1lXS5sb2FkMS5sZW5ndGggPiB0aGlzLm1heExvYWRMZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1hY2hpbmVMb2FkW2xvYWQuYmVhdC5ob3N0bmFtZV0ubG9hZDEgPSB0aGlzLm1hY2hpbmVMb2FkW2xvYWQuYmVhdC5ob3N0bmFtZV0ubG9hZDEuc2xpY2UoMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tYWNoaW5lTG9hZFtsb2FkLmJlYXQuaG9zdG5hbWVdLmxvYWQ1LnB1c2gobG9hZC5zeXN0ZW0ubG9hZFsnNSddKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm1hY2hpbmVMb2FkW2xvYWQuYmVhdC5ob3N0bmFtZV0ubG9hZDUubGVuZ3RoID4gdGhpcy5tYXhMb2FkTGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tYWNoaW5lTG9hZFtsb2FkLmJlYXQuaG9zdG5hbWVdLmxvYWQ1ID0gdGhpcy5tYWNoaW5lTG9hZFtsb2FkLmJlYXQuaG9zdG5hbWVdLmxvYWQ1LnNsaWNlKDEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWFjaGluZUxvYWRbbG9hZC5iZWF0Lmhvc3RuYW1lXS5sb2FkMTUucHVzaChsb2FkLnN5c3RlbS5sb2FkWycxNSddKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm1hY2hpbmVMb2FkW2xvYWQuYmVhdC5ob3N0bmFtZV0ubG9hZDE1Lmxlbmd0aCA+IHRoaXMubWF4TG9hZExlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWFjaGluZUxvYWRbbG9hZC5iZWF0Lmhvc3RuYW1lXS5sb2FkMTUgPSB0aGlzLm1hY2hpbmVMb2FkW2xvYWQuYmVhdC5ob3N0bmFtZV0ubG9hZDE1LnNsaWNlKDEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tYWNoaW5lTG9hZFtsb2FkLmJlYXQuaG9zdG5hbWVdID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWQxOiBbbG9hZC5zeXN0ZW0ubG9hZFsnMSddXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkNTogW2xvYWQuc3lzdGVtLmxvYWRbJzUnXV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZDE1OiBbbG9hZC5zeXN0ZW0ubG9hZFsnMTUnXV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG5ld0xvYWQubGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobmV3TG9hZC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmF3TG9hZCA9IG5ld0xvYWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy51cGRhdGVfbG9hZChpbnRlcnZhbCk7IH0sIGludGVydmFsKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAoZTogYW55KSA9PiBjb25zb2xlLmVycm9yKGUpXHJcbiAgICAgICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlX21lc3NhZ2VzKGludGVydmFsOiBudW1iZXIpIHtcclxuICAgICAgICBsZXQgZnJvbSA9IHRoaXMuc3RhcnRUaW1lO1xyXG4gICAgICAgIGlmICh0aGlzLm1lc3NhZ2VzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgZnJvbSA9IG5ldyBEYXRlKHRoaXMubWVzc2FnZXNbMF1bJ0B0aW1lc3RhbXAnXSkuZ2V0VGltZSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbWVzc2FnZXNRdWVyeSA9IHtcclxuICAgICAgICAgICAgaW5kZXg6ICdsb2dzdGFzaC0qJyxcclxuICAgICAgICAgICAgc2Nyb2xsOiAnMzBzJyxcclxuICAgICAgICAgICAgYm9keToge1xyXG4gICAgICAgICAgICAgICAgcXVlcnk6IHtcclxuICAgICAgICAgICAgICAgICAgICBib29sOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG11c3Q6IFt7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVyeV9zdHJpbmc6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVyeTogJyonLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuYWx5emVfd2lsZGNhcmQ6IHRydWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2U6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnQHRpbWVzdGFtcCc6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3Q6IGZyb20sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdDogJ2Vwb2NoX21pbGxpcydcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1dXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY29uc3QgcnhDbGllbnQgPSBuZXcgUnhDbGllbnQodGhpcy5jbGllbnQpO1xyXG4gICAgICAgIHJ4Q2xpZW50XHJcbiAgICAgICAgICAgIC5zY3JvbGwobWVzc2FnZXNRdWVyeSlcclxuICAgICAgICAgICAgLnN1YnNjcmliZShcclxuICAgICAgICAgICAgKHJlc3BvbnNlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5ld01lc3NhZ2VzOiBhbnlbXSA9IFtdO1xyXG5cclxuICAgICAgICAgICAgICAgIHJlc3BvbnNlLmhpdHMuaGl0cy5mb3JFYWNoKChoaXQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld01lc3NhZ2VzLnB1c2goaGl0Ll9zb3VyY2UpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBuZXdNZXNzYWdlcy5zb3J0KChhOiBhbnksIGI6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChhWydAdGltZXN0YW1wJ10gPCBiWydAdGltZXN0YW1wJ10pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIC0xO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZXMgPSBuZXdNZXNzYWdlcy5jb25jYXQodGhpcy5tZXNzYWdlcyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2VzID0gdGhpcy5tZXNzYWdlcy5zbGljZSgwLCAxMDApO1xyXG5cclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyB0aGlzLnVwZGF0ZV9tZXNzYWdlcyhpbnRlcnZhbCk7IH0sIGludGVydmFsKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgKGU6IGFueSkgPT4gY29uc29sZS5lcnJvcihlKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZV9zdGF0dXMoaW50ZXJ2YWw6IG51bWJlcikge1xyXG4gICAgICAgIHRoaXMuY2xpZW50LnBpbmcoe1xyXG4gICAgICAgICAgICAvLyBwaW5nIHVzdWFsbHkgaGFzIGEgMzAwMG1zIHRpbWVvdXRcclxuICAgICAgICAgICAgcmVxdWVzdFRpbWVvdXQ6IDEwMDBcclxuICAgICAgICB9LCAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdFTEsgRG93bicsXHJcbiAgICAgICAgICAgICAgICAgICAgc3RhdHVzQ29kZTogNDAwXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnVwZGF0ZV9zdGF0dXMoaW50ZXJ2YWwpLCBpbnRlcnZhbCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cyA9IHtcclxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnT0snLFxyXG4gICAgICAgICAgICAgICAgICAgIHN0YXR1c0NvZGU6IDIwMFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy51cGRhdGVfc3RhdHVzKGludGVydmFsKSwgaW50ZXJ2YWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY2hlY2tfc3RhdHVzKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnN0YXR1cztcclxuICAgIH1cclxuXHJcbiAgICBnZXRfbWVzc2FnZXMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubWVzc2FnZXM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0X2xvYWQoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubWFjaGluZUxvYWQ7XHJcbiAgICB9XHJcbn1cclxuIl19
